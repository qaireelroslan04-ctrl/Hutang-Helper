<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hutang Helper</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

    <style>
        body { background-color: #f8f9fa; padding-bottom: 80px; }
        .app-header { background: #0d6efd; color: white; padding: 15px; border-radius: 0 0 20px 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .view-section { display: none; animation: fadeIn 0.3s; }
        .active-view { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card-debt { border: none; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 10px; }
        .btn-float { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000; }
        .qr-preview { width: 100%; max-width: 250px; height: auto; border-radius: 10px; border: 2px solid #eee; }
        .receipt-item { font-size: 0.9rem; border-bottom: 1px dashed #ddd; padding: 8px 0; }
        .user-tag { font-size: 0.7rem; background: #eef; color: #444; padding: 2px 6px; border-radius: 4px; margin-right: 2px; display: inline-block; }
        
        /* Receipt Mode Specifics */
        .receipt-card { border-left: 5px solid #0d6efd; transition: transform 0.2s; }
        .receipt-card:active { transform: scale(0.98); }
        .qty-badge { min-width: 70px; text-align: center; display: inline-block; font-weight: bold; font-size: 0.9rem; }
        .qty-btn { width: 35px; height: 35px; border-radius: 50%; padding: 0; line-height: 1; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        .claim-tag { font-size: 0.7rem; margin-right: 4px; display: inline-block; margin-top: 2px; }
    </style>
</head>
<body>

    <div class="container-fluid px-0">
        
        <div class="app-header d-flex justify-content-between align-items-center">
            <h4 class="m-0 fw-bold"><i class="fa-solid fa-hand-holding-dollar me-2"></i>Hutang Helper</h4>
            <button id="logoutBtn" class="btn btn-sm btn-outline-light d-none" onclick="app.logout()">Exit</button>
        </div>

        <div class="container">
            
            <div id="view-loading" class="view-section active-view text-center mt-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Loading System...</p>
                <div id="errorMsg" class="alert alert-danger mt-3 d-none"></div>
            </div>

            <div id="view-login" class="view-section">
                <div class="card p-4 shadow-sm border-0">
                    <h5 class="mb-3">Welcome Back</h5>
                    <div class="mb-3">
                        <label class="form-label">Who are you?</label>
                        <select id="loginUserSelect" class="form-select mb-3">
                            <option value="">Select your name...</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-100" onclick="app.login()">Enter App</button>
                    
                    <div id="manualLoginArea" class="d-none">
                        <div class="position-relative my-4">
                            <hr>
                            <span class="position-absolute top-50 start-50 translate-middle bg-white px-2 text-muted small">OR</span>
                        </div>
                        <label class="form-label">New here?</label>
                        <div class="input-group">
                            <input type="text" id="manualNameInput" class="form-control" placeholder="Type your name...">
                            <button class="btn btn-success" onclick="app.joinAsNewUser()">Join</button>
                        </div>
                    </div>

                    <hr class="my-4">
                    <div class="text-center">
                        <small class="text-muted">Setting up for the first time?</small><br>
                        <button class="btn btn-sm btn-outline-secondary mt-2" onclick="app.showAdminAuth()">Admin Setup</button>
                    </div>
                </div>
            </div>

            <div id="view-admin" class="view-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Admin Panel</h3>
                    <button class="btn btn-secondary btn-sm" onclick="app.showLogin()">Back</button>
                </div>

                <div class="card mb-3 border-0 shadow-sm p-3 bg-light">
                    <h6 class="fw-bold text-primary">App Mode</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="appMode" id="modeClassic" value="classic" onchange="app.changeAppMode('classic')">
                        <label class="form-check-label" for="modeClassic">Classic (Debt Tracking)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="appMode" id="modeReceipt" value="receipt" onchange="app.changeAppMode('receipt')">
                        <label class="form-check-label" for="modeReceipt">Receipt Session (Fast Pay)</label>
                    </div>
                </div>

                <div class="card mb-3 border-0 shadow-sm p-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="appLockSwitch" onchange="app.toggleLock()">
                        <label class="form-check-label" for="appLockSwitch">Lock App (Maintenance)</label>
                    </div>
                </div>

                <div class="card border-0 shadow-sm p-3 mb-3">
                    <h5>Manage Users</h5>
                    <div class="input-group mb-2">
                        <input type="text" id="newUserName" class="form-control" placeholder="Name">
                        <input type="tel" id="newUserPhone" class="form-control" placeholder="Phone">
                        <button class="btn btn-success" onclick="app.addUser()">Add</button>
                    </div>
                    <ul id="adminUserList" class="list-group list-group-flush mt-3"></ul>
                </div>

                <div id="adminReceiptArea" class="d-none">
                    <div class="card border-0 shadow-sm p-3">
                        <h5 class="d-flex justify-content-between">
                            Active Receipts 
                            <button class="btn btn-sm btn-primary" onclick="app.showImportModal(null)">+ New</button>
                        </h5>
                        <ul id="adminReceiptList" class="list-group list-group-flush"></ul>
                    </div>
                </div>
            </div>

            <div id="view-dashboard" class="view-section">
                <div class="text-center mb-4">
                    <h2 id="dashWelcome">Hello!</h2>
                    <p class="text-muted">What would you like to do?</p>
                </div>
                
                <div class="row g-3">
                    <div class="col-6">
                        <div class="card text-center p-4 border-0 shadow-sm h-100" onclick="app.goToMintaHutang()" style="cursor:pointer; background: #e7f1ff;">
                            <i class="fa-solid fa-file-invoice-dollar fa-3x text-primary mb-3"></i>
                            <h6>Minta Hutang</h6>
                            <small class="text-muted">Create/Edit Claims</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card text-center p-4 border-0 shadow-sm h-100" onclick="app.goToBayarHutang()" style="cursor:pointer; background: #e0f8e9;">
                            <i class="fa-solid fa-money-bill-transfer fa-3x text-success mb-3"></i>
                            <h6>Bayar Hutang</h6>
                            <small class="text-muted">Pay what you owe</small>
                        </div>
                    </div>
                </div>

                <div class="card mt-4 p-3 border-0 shadow-sm">
                    <h6><i class="fa-solid fa-id-card me-2"></i>My Profile</h6>
                    <div id="profileQrArea" class="text-center mt-2"></div>
                    <div class="mt-3">
                        <label class="form-label text-muted small">Update Payment QR (Optional)</label>
                        <input type="file" id="qrUploadInput" class="form-control form-control-sm" accept="image/*" onchange="app.uploadQR()">
                    </div>
                </div>
            </div>

            <div id="view-receipt-mode" class="view-section">
                <div class="text-center mb-4">
                    <h3 class="fw-bold">Receipt Payment</h3>
                    <p class="text-muted">Select a receipt to pay your share.</p>
                </div>
                <div id="activeReceiptsList" class="d-grid gap-3"></div>
                <div class="text-center mt-5">
                    <button class="btn btn-outline-secondary btn-sm" onclick="app.logout()">Log Out</button>
                </div>
            </div>

            <div id="view-minta" class="view-section">
                <div class="d-flex justify-content-between mb-3">
                    <h5><i class="fa-solid fa-list me-2"></i>My Claims</h5>
                    <button class="btn btn-sm btn-secondary" onclick="app.showDashboard()">Back</button>
                </div>
                <div id="myClaimsList"></div>
                <div class="text-center mt-5 text-muted" id="noClaimsMsg" style="display:none">
                    <p>You haven't created any receipts yet.</p>
                </div>
                <button class="btn btn-primary btn-float" onclick="app.showReceiptBuilder(null)"><i class="fa-solid fa-plus"></i></button>
            </div>

            <div id="view-bayar" class="view-section">
                <div class="d-flex justify-content-between mb-3">
                    <h5><i class="fa-solid fa-wallet me-2"></i>Debts to Pay</h5>
                    <button class="btn btn-sm btn-secondary" onclick="app.showDashboard()">Back</button>
                </div>
                <div id="debtsList"></div>
                <div class="text-center mt-5 text-muted" id="noDebtsMsg" style="display:none">
                    <p>You are debt free! ðŸŽ‰</p>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="importReceiptModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importModalTitle">New Receipt Session</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="importTab" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-template">Template</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-manual">Manual</button></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tab-template">
                            <p class="small text-muted">Format:<br>Event Name<br>Date<br>Tax%<br>Item Name, Quantity, Total Price</p>
                            <textarea id="importText" class="form-control" rows="8" placeholder="Mamak&#10;2025-01-01&#10;6&#10;Nasi Lemak, 3, 30.00&#10;Teh O Ais, 5, 12.50"></textarea>
                        </div>
                        <div class="tab-pane fade" id="tab-manual">
                            <div class="alert alert-info small">Use the Template tab for now. It's faster! Just type each item on a new line.</div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label fw-bold">Payment QR for this Receipt</label>
                        <input type="file" id="receiptQrInput" class="form-control form-control-sm" accept="image/*">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="btnProcessImport" onclick="app.processImport()">Create Session</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="userSelectModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="userSelectTitle">Select Your Items</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Use +/- to select how many you ate.</p>
                    <div id="userSelectItemsList" class="list-group mb-3"></div>
                    <div class="card bg-light border-0 p-3 sticky-bottom">
                        <div class="d-flex justify-content-between mb-2"><span>Subtotal:</span><span id="usSubtotal">RM 0.00</span></div>
                        <div class="d-flex justify-content-between mb-2 text-muted small"><span>Tax (<span id="usTaxPct">0</span>%):</span><span id="usTaxAmt">RM 0.00</span></div>
                        <div class="d-flex justify-content-between fw-bold h4 text-primary"><span>Total:</span><span id="usTotal">RM 0.00</span></div>
                        <hr>
                        <label class="form-label">Confirm Name</label>
                        <select id="usNameSelect" class="form-select mb-3"></select>
                        <button class="btn btn-success w-100 btn-lg" onclick="app.confirmSelection()">Confirm & Pay</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="receiptModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white"><h5 class="modal-title" id="receiptModalTitle">Create Receipt</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body bg-light">
                    <div class="card border-0 shadow-sm p-3 mb-3">
                        <div class="row g-2"><div class="col-8"><input type="text" id="receiptName" class="form-control fw-bold" placeholder="Event Name"></div><div class="col-4"><input type="date" id="receiptDate" class="form-control"></div></div>
                    </div>
                    <div class="card border-0 shadow-sm p-3 mb-3">
                        <h6 class="text-primary fw-bold mb-3">Add Item</h6>
                        <div class="row g-2 align-items-center mb-2"><div class="col-8"><input type="text" id="newItemName" class="form-control form-control-sm" placeholder="Item"></div><div class="col-4"><div class="input-group input-group-sm"><span class="input-group-text">RM</span><input type="number" id="newItemPrice" class="form-control"></div></div></div>
                        <label class="form-label small text-muted mb-1">Who shared?</label>
                        <div class="d-flex flex-wrap gap-2 mb-3" id="newItemUsers"></div>
                        <button class="btn btn-outline-primary btn-sm w-100" onclick="app.addItemToReceipt()">Add Line Item</button>
                    </div>
                    <div class="card border-0 shadow-sm p-3 mb-3">
                        <h6 class="fw-bold border-bottom pb-2">Receipt Preview</h6>
                        <div id="receiptItemsList"></div>
                        <div class="row mt-3 align-items-center"><div class="col-6 text-end small">Tax/Service (%):</div><div class="col-6"><input type="number" id="receiptTax" class="form-control form-control-sm" value="0" oninput="app.calculateReceiptTotal()"></div></div>
                        <h4 class="text-end fw-bold mt-3 text-primary" id="receiptGrandTotal">Total: RM 0.00</h4>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger me-auto d-none" id="btnDeleteClaim" onclick="app.deleteClaim()">Delete</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success px-4" id="btnSaveClaim" onclick="app.saveReceipt()">Save & Send</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="payModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="payModalTitle">Pay</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body text-center"><h2 class="text-success fw-bold my-3" id="payTotalDisplay">RM 0.00</h2><div id="payQrDisplay" class="mb-3"></div><p class="text-muted small">Scan to pay.</p></div>
                <div class="modal-footer flex-column"><button type="button" class="btn btn-success w-100 mb-2" id="btnWhatsappPay"><i class="fa-brands fa-whatsapp me-2"></i>Send "Dah Bayar"</button><button type="button" class="btn btn-light w-100" data-bs-dismiss="modal">Close</button></div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="viewDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Receipt Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body"><h5 id="detailTitle" class="fw-bold"></h5><p class="text-muted small" id="detailDate"></p><hr><div id="detailItemsList"></div><hr><div class="d-flex justify-content-between fw-bold"><span>Total Bill:</span><span id="detailTotalBill"></span></div><div class="alert alert-info mt-3"><small>Your Share:</small><h4 class="fw-bold m-0" id="detailMyShare">RM 0.00</h4></div></div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBd9E9VkE7bllIN13NYGz801F4Jue_VzVk",
            authDomain: "im-helper-d3a4a.firebaseapp.com",
            projectId: "im-helper-d3a4a",
            storageBucket: "im-helper-d3a4a.firebasestorage.app",
            messagingSenderId: "772636018512",
            appId: "1:772636018512:web:24321bf201d8d48c6f4e55",
            measurementId: "G-1VGR5GJR3V"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            
            class HutangApp {
                constructor() {
                    this.state = { user: null, allUsers: [], isLocked: false, appMode: 'classic', tempItems: [], editingClaimId: null, currentReceiptSession: null, editingSessionId: null };
                    this.init();
                }

                init() {
                    this.listenToSettings();
                    this.listenToUsers();
                    this.listenToReceipts(); 
                }

                // --- DATA LISTENERS ---
                listenToSettings() {
                    db.collection("app_settings").onSnapshot((snap) => {
                        if (snap.empty) { db.collection("app_settings").add({ isLocked: false, appMode: 'classic' }); } 
                        else {
                            const data = snap.docs[0].data();
                            this.state.isLocked = data.isLocked;
                            this.state.appMode = data.appMode || 'classic';
                            this.settingsDocId = snap.docs[0].id;
                            
                            document.getElementById('appLockSwitch').checked = this.state.isLocked;
                            if(this.state.appMode === 'receipt') {
                                document.getElementById('modeReceipt').checked = true;
                                document.getElementById('manualLoginArea').classList.remove('d-none');
                                document.getElementById('adminReceiptArea').classList.remove('d-none');
                            } else {
                                document.getElementById('modeClassic').checked = true;
                                document.getElementById('manualLoginArea').classList.add('d-none');
                                document.getElementById('adminReceiptArea').classList.add('d-none');
                            }
                            if(this.state.user) this.routeUser();
                        }
                    });
                }

                listenToUsers() {
                    db.collection("users").orderBy("name").onSnapshot((snap) => {
                        this.state.allUsers = [];
                        const list = document.getElementById('adminUserList');
                        const select = document.getElementById('loginUserSelect');
                        const rSelect = document.getElementById('usNameSelect'); 
                        list.innerHTML = '';
                        select.innerHTML = '<option value="">Select your name...</option>';
                        rSelect.innerHTML = '<option value="">Select Name...</option>';
                        snap.forEach((doc) => {
                            const u = { id: doc.id, ...doc.data() };
                            this.state.allUsers.push(u);
                            list.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center"><div><strong>${u.name}</strong> <br><small>${u.phone}</small></div><button class="btn btn-sm btn-outline-danger" onclick="app.deleteUser('${u.id}')"><i class="fa-solid fa-trash"></i></button></li>`;
                            select.innerHTML += `<option value="${u.id}">${u.name}</option>`;
                            rSelect.innerHTML += `<option value="${u.id}">${u.name}</option>`;
                        });
                        if(document.querySelector('.active-view').id === 'view-loading') this.showView('view-login');
                    });
                }

                listenToReceipts() {
                    db.collection("receipt_sessions").onSnapshot(snap => {
                        const adminList = document.getElementById('adminReceiptList');
                        const userList = document.getElementById('activeReceiptsList');
                        adminList.innerHTML = '';
                        userList.innerHTML = '';
                        snap.forEach(doc => {
                            const r = { id: doc.id, ...doc.data() };
                            const rJson = encodeURIComponent(JSON.stringify(r));
                            adminList.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center"><div><strong>${r.name}</strong> <br> <small>${r.date}</small></div><div><button class="btn btn-sm btn-secondary me-1" onclick="app.showImportModal('${rJson}')">Edit</button><button class="btn btn-sm btn-danger" onclick="app.deleteReceiptSession('${r.id}')">Delete</button></div></li>`;
                            userList.innerHTML += `<div class="card shadow-sm receipt-card p-3 mb-2" onclick="app.openUserReceiptSelect('${r.id}')" style="cursor:pointer"><div class="d-flex justify-content-between align-items-center"><div><h5 class="fw-bold mb-0">${r.name}</h5><small class="text-muted">${r.date}</small></div><i class="fa-solid fa-chevron-right text-muted"></i></div></div>`;
                            
                            // REAL TIME UPDATE FOR OPEN MODAL
                            if (this.state.currentReceiptSession && this.state.currentReceiptSession.id === r.id) {
                                // If the modal is open, we update the data in the background
                                // But we only force re-render if the user isn't actively interacting to prevent glitches.
                                // Actually, for "Automatic reduction", we MUST update.
                                this.state.currentReceiptSession = r;
                                if(document.getElementById('userSelectModal').classList.contains('show')) {
                                    this.renderReceiptSessionModal();
                                }
                            }
                        });
                    });
                }

                // --- AUTH ---
                joinAsNewUser() {
                    const name = document.getElementById('manualNameInput').value.trim();
                    if(!name) return alert("Please type a name.");
                    const existing = this.state.allUsers.find(u => u.name.toLowerCase() === name.toLowerCase());
                    if(existing) {
                        if(confirm(`"${existing.name}" already exists. Log in as them?`)) {
                            this.state.user = existing;
                            this.routeUser();
                        }
                        return;
                    }
                    db.collection("users").add({ name: name, phone: "", qrImage: "" }).then(docRef => {
                        this.state.user = { id: docRef.id, name: name, phone: "", qrImage: "" };
                        this.routeUser();
                    });
                }

                login() {
                    const uid = document.getElementById('loginUserSelect').value;
                    if(!uid) return alert("Select name");
                    if(this.state.isLocked) return alert("App Locked");
                    this.state.user = this.state.allUsers.find(u => u.id === uid);
                    this.routeUser();
                }

                routeUser() {
                    if (this.state.appMode === 'receipt') {
                        this.showView('view-receipt-mode');
                    } else {
                        document.getElementById('dashWelcome').innerText = `Hello, ${this.state.user.name}!`;
                        this.renderProfileQR();
                        this.showView('view-dashboard');
                    }
                }

                logout() { this.state.user = null; this.showView('view-login'); }
                showAdminAuth() { if(prompt("Password:") === "admin123") this.showView('view-admin'); else alert("Wrong"); }
                
                addUser() {
                    const name = document.getElementById('newUserName').value;
                    const phone = document.getElementById('newUserPhone').value;
                    if(name && phone) {
                        db.collection("users").add({ name, phone, qrImage: "" });
                        document.getElementById('newUserName').value = "";
                        document.getElementById('newUserPhone').value = "";
                    }
                }
                deleteUser(id) { if(confirm("Delete?")) db.collection("users").doc(id).delete(); }
                toggleLock() { db.collection("app_settings").doc(this.settingsDocId).update({ isLocked: document.getElementById('appLockSwitch').checked }); }
                changeAppMode(mode) {
                    db.collection("app_settings").doc(this.settingsDocId).update({ appMode: mode });
                    if(mode === 'receipt') document.getElementById('adminReceiptArea').classList.remove('d-none');
                    else document.getElementById('adminReceiptArea').classList.add('d-none');
                }
                showLogin() { this.showView('view-login'); }

                // --- RECEIPT IMPORT (NEW LOGIC) ---
                showImportModal(jsonData) {
                    document.getElementById('receiptQrInput').value = '';
                    if(jsonData) {
                        const data = JSON.parse(decodeURIComponent(jsonData));
                        this.state.editingSessionId = data.id;
                        document.getElementById('importModalTitle').innerText = "Edit Receipt Session";
                        document.getElementById('btnProcessImport').innerText = "Update Session";
                        let text = `${data.name}\n${data.date}\n${data.taxPercent}`;
                        data.items.forEach(i => {
                            const q = i.qty || 1;
                            text += `\n${i.name}, ${q}, ${i.totalPrice.toFixed(2)}`;
                        });
                        document.getElementById('importText').value = text;
                    } else {
                        this.state.editingSessionId = null;
                        document.getElementById('importModalTitle').innerText = "New Receipt Session";
                        document.getElementById('btnProcessImport').innerText = "Create Session";
                        document.getElementById('importText').value = '';
                    }
                    new bootstrap.Modal(document.getElementById('importReceiptModal')).show();
                }

                processImport() {
                    const text = document.getElementById('importText').value;
                    const lines = text.split('\n').map(l => l.trim()).filter(l => l !== '');
                    if(lines.length < 4) return alert("Invalid format. Need at least 4 lines.");
                    const name = lines[0];
                    const date = lines[1];
                    const tax = parseFloat(lines[2]) || 0;
                    let items = [];
                    for(let i=3; i<lines.length; i++) {
                        const parts = lines[i].split(',').map(s => s.trim());
                        if(parts.length >= 2) {
                            const iName = parts[0];
                            let iQty = 1;
                            let iTotal = 0;
                            if(parts.length === 2) {
                                iTotal = parseFloat(parts[1]);
                            } else if (parts.length === 3) {
                                iQty = parseInt(parts[1]) || 1;
                                iTotal = parseFloat(parts[2]);
                            }
                            if(!isNaN(iTotal)) {
                                items.push({
                                    id: Date.now() + i,
                                    name: iName,
                                    qty: iQty,
                                    totalPrice: iTotal,
                                    unitPrice: iTotal / iQty,
                                    claims: {} // Map: uid -> count
                                });
                            }
                        }
                    }
                    const file = document.getElementById('receiptQrInput').files[0];
                    const finishSave = (qrBase64) => {
                        const payload = { name, date, taxPercent: tax, items };
                        if(qrBase64) payload.sessionQr = qrBase64;
                        if(this.state.editingSessionId) {
                            db.collection("receipt_sessions").doc(this.state.editingSessionId).update(payload)
                            .then(() => bootstrap.Modal.getInstance(document.getElementById('importReceiptModal')).hide());
                        } else {
                            db.collection("receipt_sessions").add(payload)
                            .then(() => bootstrap.Modal.getInstance(document.getElementById('importReceiptModal')).hide());
                        }
                    };
                    if(file) {
                        const reader = new FileReader();
                        reader.onload = (e) => finishSave(e.target.result);
                        reader.readAsDataURL(file);
                    } else { finishSave(null); }
                }
                deleteReceiptSession(id) { if(confirm("Delete?")) db.collection("receipt_sessions").doc(id).delete(); }

                // --- USER RECEIPT SELECTION (REAL TIME + NAMES) ---
                openUserReceiptSelect(rid) {
                    db.collection("receipt_sessions").doc(rid).get().then(doc => {
                        if(!doc.exists) return alert("Receipt not found.");
                        this.state.currentReceiptSession = { id: doc.id, ...doc.data() };
                        this.renderReceiptSessionModal();
                        new bootstrap.Modal(document.getElementById('userSelectModal')).show();
                    });
                }

                renderReceiptSessionModal() {
                    const r = this.state.currentReceiptSession;
                    const myUid = this.state.user.id;
                    document.getElementById('userSelectTitle').innerText = r.name;
                    const list = document.getElementById('userSelectItemsList');
                    list.innerHTML = '';

                    r.items.forEach((item, index) => {
                        if (!item.claims) item.claims = {};
                        if (!item.qty) item.qty = 1;
                        if (!item.unitPrice) item.unitPrice = item.totalPrice; 

                        // 1. Calculate how many are taken by ALL users
                        let totalClaimed = 0;
                        let claimTagsHtml = '';
                        
                        Object.keys(item.claims).forEach(uid => {
                            const count = item.claims[uid];
                            totalClaimed += count;
                            if(count > 0) {
                                // Find user name
                                const u = this.state.allUsers.find(x => x.id === uid);
                                const uName = u ? u.name : 'Unknown';
                                claimTagsHtml += `<span class="badge bg-info text-dark claim-tag">${uName} x${count}</span>`;
                            }
                        });

                        const remaining = item.qty - totalClaimed;
                        const myCount = item.claims[myUid] || 0; // Current user's confirmed/selected count from DB state
                        // Note: In this version, we are modifying DB state directly, so myCount is what is in DB.
                        
                        list.innerHTML += `
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <div>
                                        <strong>${item.name}</strong>
                                        <div class="small text-muted">RM ${item.unitPrice.toFixed(2)}</div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge ${remaining > 0 ? 'bg-success' : 'bg-secondary'}">
                                            Rem: ${remaining} / ${item.qty}
                                        </span>
                                    </div>
                                </div>
                                <div class="mb-2">${claimTagsHtml}</div>
                                <div class="d-flex justify-content-end align-items-center bg-light rounded p-2">
                                    <button class="btn btn-sm btn-outline-danger qty-btn" onclick="app.adjustItemQty(${index}, -1)">-</button>
                                    <span class="qty-badge mx-2">${myCount}</span>
                                    <button class="btn btn-sm btn-outline-success qty-btn" onclick="app.adjustItemQty(${index}, 1)">+</button>
                                </div>
                            </div>
                        `;
                    });
                    this.calculateUserReceiptTotal();
                }

                adjustItemQty(index, delta) {
                    const item = this.state.currentReceiptSession.items[index];
                    const myUid = this.state.user.id;
                    
                    if (!item.claims) item.claims = {};
                    const currentMyQty = item.claims[myUid] || 0;
                    
                    // Calc total claimed by others
                    let otherClaimed = 0;
                    Object.keys(item.claims).forEach(uid => {
                        if(uid !== myUid) otherClaimed += item.claims[uid];
                    });

                    const newMyQty = currentMyQty + delta;

                    // Validation
                    if (newMyQty < 0) return; 
                    if ((newMyQty + otherClaimed) > item.qty) return alert("Max quantity reached for this item!");

                    // Update local object immediately for responsiveness
                    item.claims[myUid] = newMyQty;
                    
                    // Trigger Re-render (Optimistic update)
                    this.renderReceiptSessionModal();
                }

                calculateUserReceiptTotal() {
                    const r = this.state.currentReceiptSession;
                    const myUid = this.state.user.id;
                    let subtotal = 0;

                    r.items.forEach(item => {
                        const myQty = item.claims ? (item.claims[myUid] || 0) : 0;
                        const price = item.unitPrice || item.totalPrice || 0; 
                        subtotal += (myQty * price);
                    });

                    const taxAmt = subtotal * (r.taxPercent / 100);
                    const total = subtotal + taxAmt;

                    document.getElementById('usSubtotal').innerText = `RM ${subtotal.toFixed(2)}`;
                    document.getElementById('usTaxPct').innerText = r.taxPercent;
                    document.getElementById('usTaxAmt').innerText = `RM ${taxAmt.toFixed(2)}`;
                    document.getElementById('usTotal').innerText = `RM ${total.toFixed(2)}`;
                    document.getElementById('usNameSelect').value = this.state.user.id;
                }

                confirmSelection() {
                    const r = this.state.currentReceiptSession;
                    const uid = document.getElementById('usNameSelect').value;
                    if(!uid) return alert("Select Name");

                    // Save the ENTIRE updated item list (with modified claims) to Firestore
                    db.collection("receipt_sessions").doc(r.id).update({ items: r.items }).then(() => {
                        bootstrap.Modal.getInstance(document.getElementById('userSelectModal')).hide();
                        
                        const totalStr = document.getElementById('usTotal').innerText; 
                        document.getElementById('payTotalDisplay').innerText = totalStr;
                        const qrDiv = document.getElementById('payQrDisplay');
                        
                        if(r.sessionQr) qrDiv.innerHTML = `<img src="${r.sessionQr}" class="qr-preview">`;
                        else qrDiv.innerHTML = `<div class="alert alert-warning">No Receipt QR set. Pay to Host.</div>`;
                        
                        document.getElementById('btnWhatsappPay').style.display = 'none'; 
                        new bootstrap.Modal(document.getElementById('payModal')).show();
                    });
                }

                // --- UTILS & CLASSIC FUNCTIONS ---
                showView(viewId) {
                    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
                    document.getElementById(viewId).classList.add('active-view');
                    const logoutBtn = document.getElementById('logoutBtn');
                    if(viewId === 'view-login' || viewId === 'view-loading') logoutBtn.classList.add('d-none');
                    else logoutBtn.classList.remove('d-none');
                }
                logout() { this.state.user = null; this.showView('view-login'); }
                renderProfileQR() {
                    const div = document.getElementById('profileQrArea');
                    if(this.state.user.qrImage) div.innerHTML = `<img src="${this.state.user.qrImage}" class="qr-preview mb-2"><br><small class="text-success">QR Active</small>`;
                    else div.innerHTML = `<h5>${this.state.user.phone}</h5><small class="text-muted">No QR</small>`;
                }
                uploadQR() {
                    const file = document.getElementById('qrUploadInput').files[0];
                    if(file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            db.collection("users").doc(this.state.user.id).update({ qrImage: e.target.result });
                            this.state.user.qrImage = e.target.result;
                            this.renderProfileQR();
                        };
                        reader.readAsDataURL(file);
                    }
                }
                showReceiptBuilder(existingClaimJson) {
                    this.state.tempItems = [];
                    const container = document.getElementById('newItemUsers');
                    container.innerHTML = `<div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="checkAllItems" onchange="app.toggleAllItemUsers(this)"><label class="form-check-label small fw-bold" for="checkAllItems">All</label></div>`;
                    const sorted = [...this.state.allUsers].sort((a,b) => (a.id === this.state.user.id ? -1 : 1));
                    sorted.forEach(u => {
                        const isSelf = u.id === this.state.user.id;
                        container.innerHTML += `<div class="form-check form-check-inline"><input class="form-check-input item-user-check" type="checkbox" value="${u.id}" id="u-${u.id}"><label class="form-check-label small" for="u-${u.id}">${isSelf ? 'Me' : u.name}</label></div>`;
                    });
                    if (existingClaimJson) {
                        const data = JSON.parse(decodeURIComponent(existingClaimJson));
                        this.state.editingClaimId = data.id; 
                        document.getElementById('receiptModalTitle').innerText = "Edit Receipt";
                        document.getElementById('btnSaveClaim').innerText = "Update";
                        document.getElementById('btnDeleteClaim').classList.remove('d-none');
                        document.getElementById('receiptName').value = data.itemName;
                        document.getElementById('receiptDate').value = data.date;
                        document.getElementById('receiptTax').value = data.taxPercent;
                        this.state.tempItems = data.items || [];
                    } else {
                        this.state.editingClaimId = null;
                        document.getElementById('receiptModalTitle').innerText = "Create Receipt";
                        document.getElementById('btnSaveClaim').innerText = "Save & Send";
                        document.getElementById('btnDeleteClaim').classList.add('d-none');
                        document.getElementById('receiptName').value = "";
                        document.getElementById('receiptDate').valueAsDate = new Date();
                        document.getElementById('receiptTax').value = 0;
                    }
                    document.getElementById('newItemName').value = "";
                    document.getElementById('newItemPrice').value = "";
                    this.renderReceiptItems();
                    new bootstrap.Modal(document.getElementById('receiptModal')).show();
                }
                toggleAllItemUsers(master) { document.querySelectorAll('.item-user-check').forEach(cb => cb.checked = master.checked); }
                addItemToReceipt() {
                    const name = document.getElementById('newItemName').value;
                    const price = parseFloat(document.getElementById('newItemPrice').value);
                    const checkboxes = document.querySelectorAll('.item-user-check:checked');
                    if(!name || isNaN(price)) return alert("Enter item name and price");
                    if(checkboxes.length === 0) return alert("Select who shared this item");
                    const involved = Array.from(checkboxes).map(cb => cb.value);
                    this.state.tempItems.push({ id: Date.now(), name, price, involved });
                    document.getElementById('newItemName').value = "";
                    document.getElementById('newItemPrice').value = "";
                    document.getElementById('checkAllItems').checked = false;
                    document.querySelectorAll('.item-user-check').forEach(cb => cb.checked = false);
                    document.getElementById('newItemName').focus();
                    this.renderReceiptItems();
                }
                deleteReceiptItem(id) {
                    this.state.tempItems = this.state.tempItems.filter(i => i.id !== id);
                    this.renderReceiptItems();
                }
                renderReceiptItems() {
                    const list = document.getElementById('receiptItemsList');
                    list.innerHTML = "";
                    if(this.state.tempItems.length === 0) list.innerHTML = `<div class="text-center text-muted small py-3">No items added yet.</div>`;
                    this.state.tempItems.forEach(item => {
                        let tags = item.involved.map(uid => {
                            const u = this.state.allUsers.find(x => x.id === uid);
                            return u ? `<span class="user-tag">${u.name}</span>` : '';
                        }).join("");
                        list.innerHTML += `<div class="receipt-item d-flex justify-content-between align-items-center"><div style="width: 70%"><div class="fw-bold">${item.name}</div><div>${tags}</div></div><div class="text-end"><div class="fw-bold">RM ${item.price.toFixed(2)}</div><button class="btn btn-link text-danger p-0" style="font-size:0.8rem" onclick="app.deleteReceiptItem(${item.id})">Remove</button></div></div>`;
                    });
                    this.calculateReceiptTotal();
                }
                calculateReceiptTotal() {
                    const taxPercent = parseFloat(document.getElementById('receiptTax').value) || 0;
                    let subtotal = this.state.tempItems.reduce((acc, item) => acc + item.price, 0);
                    let total = subtotal + (subtotal * taxPercent / 100);
                    document.getElementById('receiptGrandTotal').innerText = `Total: RM ${total.toFixed(2)}`;
                }
                saveReceipt() {
                    const receiptName = document.getElementById('receiptName').value;
                    const date = document.getElementById('receiptDate').value;
                    const taxPercent = parseFloat(document.getElementById('receiptTax').value) || 0;
                    if(this.state.tempItems.length === 0) return alert("Add at least one item.");
                    if(!receiptName) return alert("Enter Event Name");
                    let debtors = [];
                    let breakdown = {};
                    this.state.tempItems.forEach(item => {
                        const splitPrice = item.price / item.involved.length;
                        item.involved.forEach(uid => {
                            if(!breakdown[uid]) breakdown[uid] = 0;
                            breakdown[uid] += splitPrice;
                        });
                    });
                    let totalBill = 0;
                    Object.keys(breakdown).forEach(uid => {
                        const amt = breakdown[uid];
                        const finalAmt = amt + (amt * taxPercent / 100);
                        totalBill += finalAmt;
                        if(uid !== this.state.user.id) {
                            const u = this.state.allUsers.find(x => x.id === uid);
                            if(u) debtors.push({ userId: uid, name: u.name, amount: finalAmt });
                        }
                    });
                    const payload = {
                        createdBy: this.state.user.id,
                        createdByName: this.state.user.name,
                        itemName: receiptName,
                        date: date,
                        taxPercent: taxPercent,
                        totalWithTax: totalBill,
                        items: this.state.tempItems,
                        debtors: debtors,
                        debtorIds: debtors.map(d => d.userId)
                    };
                    const handleSuccess = () => {
                        bootstrap.Modal.getInstance(document.getElementById('receiptModal')).hide();
                        this.loadMyClaims();
                        this.showView('view-minta'); 
                    };
                    if(this.state.editingClaimId) {
                        db.collection("claims").doc(this.state.editingClaimId).update(payload).then(handleSuccess).catch(e => alert(e.message));
                    } else {
                        db.collection("claims").add(payload).then(handleSuccess).catch(e => alert(e.message));
                    }
                }
                deleteClaim() {
                    if(confirm("Are you sure you want to delete this receipt permanently?")) {
                        db.collection("claims").doc(this.state.editingClaimId).delete().then(() => {
                            bootstrap.Modal.getInstance(document.getElementById('receiptModal')).hide();
                            this.loadMyClaims();
                        });
                    }
                }
                goToMintaHutang() { this.showView('view-minta'); this.loadMyClaims(); }
                loadMyClaims() {
                    const list = document.getElementById('myClaimsList');
                    list.innerHTML = '<div class="spinner-border text-primary"></div>';
                    db.collection("claims").where("createdBy", "==", this.state.user.id).get().then(snap => {
                        list.innerHTML = "";
                        if(snap.empty) document.getElementById('noClaimsMsg').style.display = 'block';
                        else {
                            document.getElementById('noClaimsMsg').style.display = 'none';
                            let docs = [];
                            snap.forEach(d => docs.push({ id: d.id, ...d.data() })); 
                            docs.sort((a, b) => new Date(b.date) - new Date(a.date));
                            docs.forEach(d => {
                                const json = encodeURIComponent(JSON.stringify(d));
                                let debtTags = d.debtors.map(x => `<span class="badge bg-white text-dark border me-1">${x.name}: RM${x.amount.toFixed(2)}</span>`).join("");
                                list.innerHTML += `<div class="card card-debt p-3"><div class="d-flex justify-content-between align-items-start"><div><h6 class="fw-bold mb-0">${d.itemName}</h6><small class="text-muted">${d.date}</small></div><button class="btn btn-sm btn-outline-secondary" onclick="app.showReceiptBuilder('${json}')"><i class="fa-solid fa-pencil"></i></button></div><div class="mt-2 mb-2">${debtTags}</div><div class="text-end border-top pt-2"><small class="text-muted">Total Receipt:</small> <strong>RM ${d.totalWithTax.toFixed(2)}</strong></div></div>`;
                            });
                        }
                    }).catch(e => { alert("Error loading claims: " + e.message); });
                }
                goToBayarHutang() {
                    this.showView('view-bayar');
                    const list = document.getElementById('debtsList');
                    list.innerHTML = '<div class="spinner-border text-primary"></div>';
                    db.collection("claims").where("debtorIds", "array-contains", this.state.user.id).get().then(snap => {
                        list.innerHTML = "";
                        if(snap.empty) {
                            document.getElementById('noDebtsMsg').style.display = 'block';
                            return;
                        }
                        document.getElementById('noDebtsMsg').style.display = 'none';
                        let groups = {};
                        let docs = [];
                        snap.forEach(d => docs.push({ id: d.id, data: d.data() }));
                        docs.sort((a, b) => new Date(b.data.date) - new Date(a.data.date));
                        docs.forEach(doc => {
                            const d = doc.data;
                            const myDebt = d.debtors.find(x => x.userId === this.state.user.id);
                            if(!groups[d.createdBy]) groups[d.createdBy] = { name: d.createdByName, id: d.createdBy, debts: [] };
                            groups[d.createdBy].debts.push({ id: doc.id, data: d, amount: myDebt.amount });
                        });
                        Object.values(groups).forEach(g => {
                            let rows = "";
                            g.debts.forEach((item, idx) => {
                                const itemJson = encodeURIComponent(JSON.stringify(item.data));
                                rows += `<div class="d-flex justify-content-between align-items-center border-bottom py-2"><div class="form-check"><input class="form-check-input debt-check-${g.id}" type="checkbox" value="${item.amount}" id="cb-${g.id}-${idx}"><label class="form-check-label" for="cb-${g.id}-${idx}">${item.data.itemName} <br> <small class="text-muted">${item.data.date}</small></label></div><div class="text-end"><div class="fw-bold">RM ${item.amount.toFixed(2)}</div><button class="btn btn-link p-0 text-decoration-none small" onclick="app.viewReceiptDetails('${itemJson}')">View Receipt</button></div></div>`;
                            });
                            list.innerHTML += `<div class="card p-3 mb-3 border-0 shadow-sm"><h6 class="text-primary fw-bold border-bottom pb-2 mb-0">Owe to: ${g.name}</h6><div class="mb-3">${rows}</div><button class="btn btn-success w-100" onclick="app.openPayModal('${g.id}')">Pay Selected</button></div>`;
                        });
                    }).catch(e => { alert("Error loading debts: " + e.message); });
                }
                viewReceiptDetails(encodedJson) {
                    const data = JSON.parse(decodeURIComponent(encodedJson));
                    const myUid = this.state.user.id;
                    document.getElementById('detailTitle').innerText = data.itemName;
                    document.getElementById('detailDate').innerText = data.date;
                    document.getElementById('detailTotalBill').innerText = `RM ${data.totalWithTax.toFixed(2)}`;
                    const list = document.getElementById('detailItemsList');
                    list.innerHTML = "";
                    if(!data.items) {
                        list.innerHTML = "<p>Legacy receipt (No details available).</p>";
                    } else {
                        data.items.forEach(item => {
                            const isMe = item.involved.includes(myUid);
                            const highlight = isMe ? "bg-light border-start border-4 border-success" : "";
                            let userNames = item.involved.map(uid => {
                                const u = this.state.allUsers.find(x => x.id === uid);
                                return u ? u.name : "Unknown";
                            }).join(", ");
                            list.innerHTML += `<div class="p-2 mb-1 ${highlight}"><div class="d-flex justify-content-between"><strong>${item.name}</strong><span>RM ${item.price.toFixed(2)}</span></div><small class="text-muted">Shared by: ${userNames}</small></div>`;
                        });
                    }
                    const myShare = data.debtors.find(d => d.userId === myUid)?.amount || 0;
                    document.getElementById('detailMyShare').innerText = `RM ${myShare.toFixed(2)}`;
                    new bootstrap.Modal(document.getElementById('viewDetailsModal')).show();
                }
                openPayModal(creditorId) {
                    const cbs = document.querySelectorAll(`.debt-check-${creditorId}:checked`);
                    if(cbs.length === 0) return alert("Select item to pay");
                    let total = 0;
                    cbs.forEach(cb => total += parseFloat(cb.value));
                    const creditor = this.state.allUsers.find(u => u.id === creditorId);
                    document.getElementById('payTotalDisplay').innerText = `RM ${total.toFixed(2)}`;
                    const qrDiv = document.getElementById('payQrDisplay');
                    if(creditor.qrImage) qrDiv.innerHTML = `<img src="${creditor.qrImage}" class="qr-preview">`;
                    else qrDiv.innerHTML = `<h4>${creditor.phone}</h4>`;
                    const cleanPhone = creditor.phone.replace(/[^0-9]/g, '');
                    const msg = `Hi ${creditor.name}, paid RM ${total.toFixed(2)} via Hutang Helper.`;
                    document.getElementById('btnWhatsappPay').style.display = 'block';
                    document.getElementById('btnWhatsappPay').onclick = () => { window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`, '_blank'); };
                    new bootstrap.Modal(document.getElementById('payModal')).show();
                }
            }
            window.app = new HutangApp();
        } catch (e) {
            document.getElementById('errorMsg').innerText = e.message;
            document.getElementById('errorMsg').classList.remove('d-none');
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
